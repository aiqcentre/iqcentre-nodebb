"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[9593,70565,83014,99617,42550,74344],{94039:(E,v,c)=>{var g,y;g=[c(98192),c(74344),c(63281),c(7927)],y=((p,C,b,d)=>{const f={};f.openChangeModal=()=>{socket.emit("user.getProfilePictures",{uid:ajaxify.data.uid},function(a,n){if(a)return d.error(a);const r=n.reduce(function(o,e){return o||e.type==="uploaded"},!1);app.parseAndTranslate("modals/change-picture",{pictures:n,uploaded:r,icon:{text:ajaxify.data["icon:text"],bgColor:ajaxify.data["icon:bgColor"]},defaultAvatar:ajaxify.data.defaultAvatar,allowProfileImageUploads:ajaxify.data.allowProfileImageUploads,iconBackgrounds:config.iconBackgrounds,user:{uid:ajaxify.data.uid,username:ajaxify.data.username,picture:ajaxify.data.picture,"icon:text":ajaxify.data["icon:text"],"icon:bgColor":ajaxify.data["icon:bgColor"]}},function(o){const e=b.dialog({className:"picture-switcher",title:"[[user:change_picture]]",message:o,show:!0,size:"large",buttons:{close:{label:"[[global:close]]",callback:m,className:"btn-link"},update:{label:"[[global:save_changes]]",callback:s}}});e.on("shown.bs.modal",i),e.on("click",".list-group-item",function(){e.find(".list-group-item").removeClass("active"),$(this).addClass("active")}),e.on("change",'input[type="radio"][name="icon:bgColor"]',u=>{const h=u.target.value;e.find('[component="avatar/icon"]').css("background-color",h)}),t(e);function i(){ajaxify.data.picture?e.find(".list-group-item img").each(function(){this.getAttribute("src")===ajaxify.data.picture&&$(this).parents(".list-group-item").addClass("active")}):e.find('[data-type="default"]').addClass("active");const u=document.querySelector(`.modal input[type="radio"][value="${ajaxify.data["icon:bgColor"]}"]`);u?u.checked=!0:document.querySelector('.modal input[type="radio"]').checked=!0}function s(){const u=e.find(".list-group-item.active").attr("data-type"),h=document.querySelector('.modal.picture-switcher input[type="radio"]:checked').value||"transparent";l(u,h).then(()=>{f.updateHeader(u==="default"?"":e.find(".list-group-item.active img").attr("src"),h),ajaxify.refresh()}).catch(d.error)}function m(){e.modal("hide")}})})},f.updateHeader=(a,n)=>{if(parseInt(ajaxify.data.theirid,10)!==parseInt(ajaxify.data.yourid,10))return;!a&&ajaxify.data.defaultAvatar&&(a=ajaxify.data.defaultAvatar);const r=$('[component="header/avatar"] [component="avatar/picture"]'),o=$('[component="header/avatar"] [component="avatar/icon"]');if(a){if(!r.length&&o.length){const e=$("<img/>");$(o[0].attributes).each(function(){e.attr(this.nodeName,this.nodeValue)}),e.attr("component","avatar/picture").attr("src",a).insertBefore(o)}}else r.remove();n&&o.css({"background-color":n})};function t(a){function n(o){o=(o.startsWith("http")?"":config.relative_path)+o+"?"+Date.now(),f.updateHeader(o),ajaxify.data.picture&&ajaxify.data.picture.length?($("#user-current-picture, img.avatar").attr("src",o),ajaxify.data.uploadedpicture=o):ajaxify.refresh(function(){$("#user-current-picture, img.avatar").attr("src",o)})}function r(){ajaxify.data.uploadedpicture===ajaxify.data.picture&&(ajaxify.refresh(),f.updateHeader())}a.find('[data-action="upload"]').on("click",function(){return a.modal("hide"),p.show({socketMethod:"user.uploadCroppedPicture",route:config.relative_path+"/api/user/"+ajaxify.data.userslug+"/uploadpicture",aspectRatio:1/1,paramName:"uid",paramValue:ajaxify.data.theirid,fileSize:ajaxify.data.maximumProfileImageSize,allowSkippingCrop:!1,title:"[[user:upload_picture]]",description:"[[user:upload_a_picture]]",accept:ajaxify.data.allowedProfileImageExtensions},function(o){n(o)}),!1}),a.find('[data-action="upload-url"]').on("click",function(){return a.modal("hide"),app.parseAndTranslate("modals/upload-picture-from-url",{},function(o){o.modal("show"),o.find(".upload-btn").on("click",function(){const e=o.find("#uploadFromUrl").val();return e&&(o.modal("hide"),p.handleImageCrop({url:e,socketMethod:"user.uploadCroppedPicture",aspectRatio:1,allowSkippingCrop:!1,paramName:"uid",paramValue:ajaxify.data.theirid},n)),!1})}),!1}),a.find('[data-action="remove-uploaded"]').on("click",function(){socket.emit("user.removeUploadedPicture",{uid:ajaxify.data.theirid},function(o){if(a.modal("hide"),o)return d.error(o);r()})})}function l(a,n){return C.put(`/users/${ajaxify.data.theirid}/picture`,{type:a,bgColor:n})}return f}).apply(v,g),y!==void 0&&(E.exports=y)},74344:(E,v,c)=>{c.r(v),c.d(v,{del:()=>o,get:()=>t,head:()=>l,patch:()=>n,post:()=>a,put:()=>r});var g=c(85233),y=c.n(g),p=c(63281),C=c.n(p);const b=config.relative_path+"/api/v3";function d(e,i){if(e.url=e.url.startsWith("/api")?config.relative_path+e.url:b+e.url,typeof i=="function"){f(e,i);return}return new Promise((s,m)=>{f(e,function(u,h){if(u)return u.message==="A valid login session was not found. Please log in and try again."?(0,p.confirm)("[[error:api.reauth-required]]",D=>{D&&ajaxify.go("login")}):m(u);s(h)})})}async function f(e,i){const{url:s}=e;delete e.url,e.data&&!(e.data instanceof FormData)&&(e.data=JSON.stringify(e.data||{}),e.headers["content-type"]="application/json; charset=utf-8"),{options:e}=await(0,g.fire)("filter:api.options",{options:e}),e.data&&(e.body=e.data,delete e.data);const m=await fetch(s,e),{headers:u}=m,h=u.get("content-type"),D=h&&h.startsWith("application/json");let x;if(D?x=await m.json():x=await m.text(),!m.ok)return i(new Error(D?x.status.message:x));i(null,D&&x.hasOwnProperty("status")&&x.hasOwnProperty("response")?x.response:x)}function t(e,i,s){return d({url:e+(i&&Object.keys(i).length?"?"+$.param(i):"")},s)}function l(e,i,s){return d({url:e+(i&&Object.keys(i).length?"?"+$.param(i):""),method:"head"},s)}function a(e,i,s){return d({url:e,method:"post",data:i,headers:{"x-csrf-token":config.csrf_token}},s)}function n(e,i,s){return d({url:e,method:"patch",data:i,headers:{"x-csrf-token":config.csrf_token}},s)}function r(e,i,s){return d({url:e,method:"put",data:i,headers:{"x-csrf-token":config.csrf_token}},s)}function o(e,i,s){return d({url:e,method:"delete",data:i,headers:{"x-csrf-token":config.csrf_token}},s)}},98192:(E,v,c)=>{var g,y;g=[c(7927)],y=function(p){const C={};C.show=function(t,l){const a=t.hasOwnProperty("fileSize")&&t.fileSize!==void 0?parseInt(t.fileSize,10):!1;app.parseAndTranslate("modals/upload-file",{showHelp:t.hasOwnProperty("showHelp")&&t.showHelp!==void 0?t.showHelp:!0,fileSize:a,title:t.title||"[[global:upload_file]]",description:t.description||"",button:t.button||"[[global:upload]]",accept:t.accept?t.accept.replace(/,/g,"&#44; "):""},function(n){n.modal("show"),n.on("hidden.bs.modal",function(){n.remove()});const r=n.find("#uploadForm");t.route&&r.attr("action",t.route),n.find("#fileUploadSubmitBtn").on("click",function(){return $(this).addClass("disabled"),t.uploadModal=n,f(t,l),!1})})},C.handleImageCrop=function(t,l){$("#crop-picture-modal").remove(),app.parseAndTranslate("modals/crop_picture",{url:utils.escapeHTML(t.url)},async function(a){a.modal({backdrop:"static"}).modal("show");const n=parseInt($(window).height()/2,10),r=document.getElementById("cropped-image");$(r).css("max-height",n);const o=(await c.e(31649).then(c.t.bind(c,33129,23))).default;let e=new o(r,{aspectRatio:t.aspectRatio,autoCropArea:1,viewMode:1,checkCrossOrigin:!0,cropmove:function(){t.restrictImageDimension&&(e.cropBoxData.width>t.imageDimension&&e.setCropBoxData({width:t.imageDimension}),e.cropBoxData.height>t.imageDimension&&e.setCropBoxData({height:t.imageDimension}))},ready:function(){if(!d(e,t))return a.modal("hide");if(t.restrictImageDimension){const i=r.width<r.height?r.width:r.height,s=i>t.imageDimension?t.imageDimension:i;e.setCropBoxData({width:s,height:s})}a.find(".rotate").on("click",function(){const i=this.getAttribute("data-degrees");e.rotate(i)}),a.find(".flip").on("click",function(){const i=this.getAttribute("data-option");this.getAttribute("data-method")==="scaleX"?e.scaleX(i):e.scaleY(i),this.setAttribute("data-option",i*-1)}),a.find(".reset").on("click",function(){e.reset()}),a.find(".crop-btn").on("click",function(){$(this).addClass("disabled");const i=d(e,t);i&&(a.find("#upload-progress-bar").css("width","0%"),a.find("#upload-progress-box").show().removeClass("hide"),b({data:t,imageData:i,progressBarEl:a.find("#upload-progress-bar")},function(s,m){if(s)return a.find("#upload-progress-box").hide(),a.find(".upload-btn").removeClass("disabled"),a.find(".crop-btn").removeClass("disabled"),p.error(s);l(m.url),a.modal("hide")}))}),a.find(".upload-btn").on("click",async function(){$(this).addClass("disabled"),e.destroy();const i=(await c.e(31649).then(c.t.bind(c,33129,23))).default;e=new i(r,{viewMode:1,autoCropArea:1,ready:function(){a.find(".crop-btn").trigger("click")}})})}})})};function b(t,l){const a={};a[t.data.paramName]=t.data.paramValue,a.method=t.data.socketMethod,a.size=t.imageData.length,a.progress=0;const n=1e5;function r(){const o=t.imageData.slice(a.progress,a.progress+n);socket.emit("uploads.upload",{chunk:o,params:a},function(e,i){if(e)return p.error(e);if(a.progress+n<a.size)return a.progress+=o.length,t.progressBarEl.css("width",(a.progress/a.size*100).toFixed(2)+"%"),setTimeout(r,100);t.progressBarEl.css("width","100%"),l(null,i)})}r()}function d(t,l){let a;try{a=l.imageType?t.getCroppedCanvas().toDataURL(l.imageType):t.getCroppedCanvas().toDataURL()}catch(n){["The operation is insecure.","Failed to execute 'toDataURL' on 'HTMLCanvasElement': Tainted canvases may not be exported."].indexOf(n.message)!==-1?p.error("[[error:cors-error]]"):p.error(n.message);return}return a}function f(t,l){function a(i,s){i==="error"&&t.uploadModal.find("#fileUploadSubmitBtn").removeClass("disabled"),t.uploadModal.find("#alert-"+i).translateText(s).removeClass("hide")}const n=t.uploadModal.find("#fileInput");if(!n.val())return a("error","[[uploads:select-file-to-upload]]");const r=n[0].files[0],o=t.hasOwnProperty("fileSize")&&t.fileSize!==void 0?parseInt(t.fileSize,10):!1;if(o&&r.size>o*1024)return a("error","[[error:file-too-big, "+o+"]]");if(r.name.endsWith(".gif")){c.e(3564).then(function(){var i=[c(50431)];(function(s){s.ajaxSubmit(t.uploadModal,l)}).apply(null,i)}).catch(c.oe);return}const e=new FileReader;e.addEventListener("load",function(){const i=e.result;t.uploadModal.modal("hide"),C.handleImageCrop({url:i,imageType:r.type,socketMethod:t.socketMethod,aspectRatio:t.aspectRatio,allowSkippingCrop:t.allowSkippingCrop,restrictImageDimension:t.restrictImageDimension,imageDimension:t.imageDimension,paramName:t.paramName,paramValue:t.paramValue},l)},!1),r&&e.readAsDataURL(r)}return C}.apply(v,g),y!==void 0&&(E.exports=y)}}]);
