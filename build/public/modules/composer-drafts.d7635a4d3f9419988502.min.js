(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[93230,70565,83014,99617,74344],{74344:(E,p,s)=>{"use strict";s.r(p),s.d(p,{del:()=>i,get:()=>L,head:()=>O,patch:()=>e,post:()=>g,put:()=>n});var h=s(85233),S=s.n(h),v=s(63281),I=s.n(v);const a=config.relative_path+"/api/v3";function d(t,o){if(t.url=t.url.startsWith("/api")?config.relative_path+t.url:a+t.url,typeof o=="function"){f(t,o);return}return new Promise((r,u)=>{f(t,function(l,m){if(l)return l.message==="A valid login session was not found. Please log in and try again."?(0,v.confirm)("[[error:api.reauth-required]]",y=>{y&&ajaxify.go("login")}):u(l);r(m)})})}async function f(t,o){const{url:r}=t;delete t.url,t.data&&!(t.data instanceof FormData)&&(t.data=JSON.stringify(t.data||{}),t.headers["content-type"]="application/json; charset=utf-8"),{options:t}=await(0,h.fire)("filter:api.options",{options:t}),t.data&&(t.body=t.data,delete t.data);const u=await fetch(r,t),{headers:l}=u,m=l.get("content-type"),y=m&&m.startsWith("application/json");let c;if(y?c=await u.json():c=await u.text(),!u.ok)return o(new Error(y?c.status.message:c));o(null,y&&c.hasOwnProperty("status")&&c.hasOwnProperty("response")?c.response:c)}function L(t,o,r){return d({url:t+(o&&Object.keys(o).length?"?"+$.param(o):"")},r)}function O(t,o,r){return d({url:t+(o&&Object.keys(o).length?"?"+$.param(o):""),method:"head"},r)}function g(t,o,r){return d({url:t,method:"post",data:o,headers:{"x-csrf-token":config.csrf_token}},r)}function e(t,o,r){return d({url:t,method:"patch",data:o,headers:{"x-csrf-token":config.csrf_token}},r)}function n(t,o,r){return d({url:t,method:"put",data:o,headers:{"x-csrf-token":config.csrf_token}},r)}function i(t,o,r){return d({url:t,method:"delete",data:o,headers:{"x-csrf-token":config.csrf_token}},r)}},47913:(E,p,s)=>{E.exports=s(66485)},66485:(E,p,s)=>{"use strict";var h,S;h=[s(74344),s(7927)],S=function(v,I){const a={};a.init=function(e,n){const i=e.find(".draft-icon"),t=e.attr("data-uuid");function o(){$(`[component="composer"][data-uuid="${t}"]`).length&&(n.save_id||(n.save_id=utils.generateSaveId(app.user.uid)),a.addToDraftList("available",n.save_id),a.addToDraftList("open",n.save_id),L(e,i,n))}e.on("keyup","textarea, input.handle, input.title",utils.debounce(o,1e3)),e.on("click",'input[type="checkbox"]',utils.debounce(o,1e3)),e.on("click",'[component="category/list"] [data-cid]',utils.debounce(o,1e3)),e.on("itemAdded",".tags",utils.debounce(o,1e3)),e.on("thumb.uploaded",o),i.on("animationend",function(){$(this).toggleClass("active",!1)}),$(window).on("unload",function(){const r=a.getList("open");r.length&&r.forEach(u=>a.removeFromDraftList("open",u))}),a.migrateGuest(),a.migrateThumbs(...arguments)};function f(e){return parseInt(e,10)>0?localStorage:sessionStorage}a.get=function(e){if(!e)return null;const n=e.split(":")[1],i=f(n);try{const t=i.getItem(e),o=JSON.parse(t)||null;if(!o)throw new Error(`can't parse draft json for ${e}`);return o.save_id=e,o.timestamp&&(o.timestampISO=utils.toISOString(o.timestamp)),$(window).trigger("action:composer.drafts.get",{save_id:e,draft:o,storage:i}),o}catch{return console.warn(`[composer/drafts] Could not get draft ${e}, removing`),a.removeFromDraftList("available"),a.removeFromDraftList("open"),null}};function L(e,n,i){if(g(app.user.uid?"localStorage":"sessionStorage")&&i&&i.save_id&&e.length){const t=e.find("input.title"),o=t&&t.length&&t.val(),r=e.find("textarea").val(),u=f(app.user.uid);if(r.length||o&&o.length){const l={save_id:i.save_id,action:i.action,text:r,uuid:e.attr("data-uuid"),timestamp:Date.now()};if(i.action==="topics.post"){const m=e.find("input.tags").val();l.tags=m,l.title=o,l.cid=i.cid}else i.action==="posts.reply"?(l.title=i.title,l.tid=i.tid,l.toPid=i.toPid):i.action==="posts.edit"&&(l.pid=i.pid,l.title=o||i.title);app.user.uid||(l.handle=e.find("input.handle").val()),u.setItem(i.save_id,JSON.stringify(l)),$(window).trigger("action:composer.drafts.save",{storage:u,postData:i,postContainer:e}),n.toggleClass("active",!0)}else a.removeDraft(i.save_id)}}a.removeDraft=function(e){if(!e)return;a.removeFromDraftList("available",e),a.removeFromDraftList("open",e);const n=e.split(":")[1],i=f(n);i.removeItem(e),$(window).trigger("action:composer.drafts.remove",{storage:i,save_id:e})},a.getList=function(e){try{const n=localStorage.getItem(`drafts:${e}`);return JSON.parse(n)||[]}catch{return console.warn("[composer/drafts] Could not read list of available drafts"),[]}},a.addToDraftList=function(e,n){if(!g(app.user.uid?"localStorage":"sessionStorage")||!n)return;const i=a.getList(e);i.includes(n)||(i.push(n),localStorage.setItem("drafts:"+e,JSON.stringify(i)))},a.removeFromDraftList=function(e,n){if(!g(app.user.uid?"localStorage":"sessionStorage")||!n)return;const i=a.getList(e);i.includes(n)&&(i.splice(i.indexOf(n),1),localStorage.setItem("drafts:"+e,JSON.stringify(i)))},a.migrateGuest=function(){if(g("localStorage")&&app.user.uid){const e=/^composer:\d+:\d$/,n=Object.keys(sessionStorage).filter(function(o){return e.test(o)}),i=new Set([]),t=n.map(function(o){const r=o.split(":");return r[1]=app.user.uid,i.add(r.join(":")),r.join(":")});return n.forEach(function(o,r){localStorage.setItem(t[r],sessionStorage.getItem(o)),sessionStorage.removeItem(o)}),i.forEach(function(o){a.addToDraftList("available",o)}),i}},a.migrateThumbs=function(e,n){if(!app.uid)return;const i=e.attr("data-uuid"),t=a.get(n.save_id);t&&t.uuid&&v.put(`/topics/${t.uuid}/thumbs`,{tid:i}).then(()=>{Promise.all([s.e(66177),s.e(62526),s.e(61006),s.e(42265),s.e(49915),s.e(59330)]).then(function(){var o=[s(44541)];(function(r){r.updateThumbCount(i,e)}).apply(null,o)}).catch(s.oe)})},a.listAvailable=function(){return a.getList("available").map(a.get)},a.getAvailableCount=function(){return a.listAvailable().length},a.open=function(e){if(!e)return;const n=a.get(e);O(e,n)},a.loadOpen=function(){if(ajaxify.data.template.login||ajaxify.data.template.register||config.hasOwnProperty("openDraftsOnPageLoad")&&!config.openDraftsOnPageLoad)return;const e=a.getList("available"),n=a.getList("open");e.length&&e.forEach(function(i){if(!i||n.includes(i))return;const t=a.get(i);if(!t||!t.text&&!t.title){a.removeFromDraftList("available",i),a.removeFromDraftList("open",i);return}O(i,t)})};function O(e,n){const t=e.split(":")[1];parseInt(app.user.uid,10)===parseInt(t,10)&&Promise.all([s.e(66177),s.e(62526),s.e(61006),s.e(42265),s.e(49915),s.e(59330)]).then(function(){var o=[s(44541)];(function(r){n.action==="topics.post"?r.newTopic({save_id:n.save_id,cid:n.cid,handle:app.user&&app.user.uid?void 0:utils.escapeHTML(n.handle),title:utils.escapeHTML(n.title),body:n.text,tags:String(n.tags||"").split(",")}):n.action==="posts.reply"?v.get("/topics/"+n.tid,{},function(u,l){if(u)return I.error(u);r.newReply({save_id:n.save_id,tid:n.tid,toPid:n.toPid,title:l.title,body:n.text})}):n.action==="posts.edit"&&r.editPost({save_id:n.save_id,pid:n.pid,title:n.title?utils.escapeHTML(n.title):void 0,body:n.text})}).apply(null,o)}).catch(s.oe)}function g(e){var n;try{n=window[e];var i="__storage_test__";return n.setItem(i,i),n.removeItem(i),!0}catch(t){return t instanceof DOMException&&(t.code===22||t.code===1014||t.name==="QuotaExceededError"||t.name==="NS_ERROR_DOM_QUOTA_REACHED")&&n&&n.length!==0}}return a}.apply(p,h),S!==void 0&&(E.exports=S)}}]);
