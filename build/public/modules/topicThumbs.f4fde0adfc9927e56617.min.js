"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[79191,70565,83014,99617,3564,74344],{74344:(v,A,l)=>{l.r(A),l.d(A,{del:()=>c,get:()=>t,head:()=>r,patch:()=>e,post:()=>s,put:()=>a});var p=l(85233),g=l.n(p),u=l(63281),S=l.n(u);const h=config.relative_path+"/api/v3";function f(n,o){if(n.url=n.url.startsWith("/api")?config.relative_path+n.url:h+n.url,typeof o=="function"){P(n,o);return}return new Promise((i,d)=>{P(n,function(m,y){if(m)return m.message==="A valid login session was not found. Please log in and try again."?(0,u.confirm)("[[error:api.reauth-required]]",E=>{E&&ajaxify.go("login")}):d(m);i(y)})})}async function P(n,o){const{url:i}=n;delete n.url,n.data&&!(n.data instanceof FormData)&&(n.data=JSON.stringify(n.data||{}),n.headers["content-type"]="application/json; charset=utf-8"),{options:n}=await(0,p.fire)("filter:api.options",{options:n}),n.data&&(n.body=n.data,delete n.data);const d=await fetch(i,n),{headers:m}=d,y=m.get("content-type"),E=y&&y.startsWith("application/json");let b;if(E?b=await d.json():b=await d.text(),!d.ok)return o(new Error(E?b.status.message:b));o(null,E&&b.hasOwnProperty("status")&&b.hasOwnProperty("response")?b.response:b)}function t(n,o,i){return f({url:n+(o&&Object.keys(o).length?"?"+$.param(o):"")},i)}function r(n,o,i){return f({url:n+(o&&Object.keys(o).length?"?"+$.param(o):""),method:"head"},i)}function s(n,o,i){return f({url:n,method:"post",data:o,headers:{"x-csrf-token":config.csrf_token}},i)}function e(n,o,i){return f({url:n,method:"patch",data:o,headers:{"x-csrf-token":config.csrf_token}},i)}function a(n,o,i){return f({url:n,method:"put",data:o,headers:{"x-csrf-token":config.csrf_token}},i)}function c(n,o,i){return f({url:n,method:"delete",data:o,headers:{"x-csrf-token":config.csrf_token}},i)}},62023:(v,A,l)=>{var p,g;p=[l(74344),l(63281),l(7927),l(50431),l(59006),l(32230),l(62526)],g=function(u,S,h,f,P,t){const r={};return r.get=s=>u.get(`/topics/${s}/thumbs`,{}),r.getByPid=s=>u.get(`/posts/${s}`,{}).then(e=>r.get(e.tid)),r.delete=(s,e)=>u.del(`/topics/${s}/thumbs`,{path:e}),r.deleteAll=s=>{r.get(s).then(e=>{Promise.all(e.map(a=>r.delete(s,a.url)))})},r.upload=s=>new Promise(e=>{f.show({title:"[[topic:composer.thumb_title]]",method:"put",route:config.relative_path+`/api/v3/topics/${s}/thumbs`},function(a){e(a)})}),r.modal={},r.modal.open=function(s){const{id:e,pid:a}=s;let{modal:c}=s,n;return new Promise(o=>{Promise.all([r.get(e),a?r.getByPid(a):[]]).then(i=>new Promise(d=>{const m=i.reduce((y,E)=>y.concat(E));n=m.length,d(m)})).then(i=>P.render("modals/topic-thumbs",{thumbs:i})).then(i=>{c?t.translate(i,function(d){c.find(".bootbox-body").html(d),r.modal.handleSort({modal:c,numThumbs:n})}):(c=S.dialog({title:"[[modules:thumbs.modal.title]]",message:i,onEscape:!0,backdrop:!0,buttons:{add:{label:'<i class="fa fa-plus"></i> [[modules:thumbs.modal.add]]',className:"btn-success",callback:()=>(r.upload(e).then(()=>{r.modal.open({...s,modal:c}),Promise.all([l.e(61006),l.e(42265),l.e(49915),l.e(8311)]).then(function(){var d=[l(44541)];(m=>{m.updateThumbCount(e,$(`[component="composer"][data-uuid="${e}"]`)),o()}).apply(null,d)}).catch(l.oe)}),!1)},close:{label:"[[global:close]]",className:"btn-primary"}}}),r.modal.handleDelete({...s,modal:c}),r.modal.handleSort({modal:c,numThumbs:n}))})})},r.modal.handleDelete=s=>{s.modal.get(0).addEventListener("click",a=>{a.target.closest('button[data-action="remove"]')&&S.confirm("[[modules:thumbs.modal.confirm-remove]]",c=>{if(!c)return;const n=a.target.closest("[data-id]").getAttribute("data-id"),o=a.target.closest("[data-path]").getAttribute("data-path");u.del(`/topics/${n}/thumbs`,{path:o}).then(()=>{r.modal.open(s)}).catch(h.error)})})},r.modal.handleSort=({modal:s,numThumbs:e})=>{if(e>1){const a=s.find(".topic-thumbs-modal");a.sortable({items:"[data-id]"}),a.on("sortupdate",r.modal.handleSortChange)}},r.modal.handleSortChange=(s,e)=>{const a=e.item.get(0).parentNode.querySelectorAll("[data-id]");Array.from(a).forEach((c,n)=>{const o=c.getAttribute("data-id");let i=c.getAttribute("data-path");i=i.replace(new RegExp(`^${config.upload_url}`),""),u.put(`/topics/${o}/thumbs/order`,{path:i,order:n}).catch(h.error)})},r}.apply(A,p),g!==void 0&&(v.exports=g)},50431:(v,A,l)=>{var p,g;p=[l(86569)],g=function(){const u={};u.show=function(t,r){const s=t.hasOwnProperty("fileSize")&&t.fileSize!==void 0?parseInt(t.fileSize,10):!1;app.parseAndTranslate("modals/upload-file",{showHelp:t.hasOwnProperty("showHelp")&&t.showHelp!==void 0?t.showHelp:!0,fileSize:s,title:t.title||"[[global:upload_file]]",description:t.description||"",button:t.button||"[[global:upload]]",accept:t.accept?t.accept.replace(/,/g,"&#44; "):""},function(e){e.modal("show"),e.on("hidden.bs.modal",function(){e.remove()});const a=e.find("#uploadForm");a.attr("action",t.route),a.find("#params").val(JSON.stringify(t.params)),e.find("#fileUploadSubmitBtn").on("click",function(){$(this).addClass("disabled"),a.submit()}),a.submit(function(){return S(e,s,r),!1})})},u.hideAlerts=function(t){$(t).find("#alert-status, #alert-success, #alert-error, #upload-progress-box").addClass("hide")};function S(t,r,s){h(t,"status","[[uploads:uploading-file]]"),t.find("#upload-progress-bar").css("width","0%"),t.find("#upload-progress-box").show().removeClass("hide");const e=t.find("#fileInput");if(!e.val())return h(t,"error","[[uploads:select-file-to-upload]]");if(!P(e[0],r))return h(t,"error","[[error:file-too-big, "+r+"]]");u.ajaxSubmit(t,s)}function h(t,r,s){u.hideAlerts(t),r==="error"&&t.find("#fileUploadSubmitBtn").removeClass("disabled"),s=s.replace(/&amp;#44/g,"&#44"),t.find("#alert-"+r).translateText(s).removeClass("hide")}u.ajaxSubmit=function(t,r){t.find("#uploadForm").ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},error:function(e){e=f(e),h(t,"error",e.responseJSON?.status?.message||e.responseJSON?.error||`[[error:upload-error-fallback, ${e.status} ${e.statusText}]]`)},uploadProgress:function(e,a,c,n){t.find("#upload-progress-bar").css("width",n+"%")},success:function(e){let a=f(e);e.hasOwnProperty("response")&&e.hasOwnProperty("status")&&e.status.code==="ok"&&(a=e.response.images),r(a[0].url),h(t,"success","[[uploads:upload-success]]"),setTimeout(function(){u.hideAlerts(t),t.modal("hide")},750)}})};function f(t){if(typeof t=="string")try{return JSON.parse(t)}catch{return{error:"[[error:parse-error]]"}}return t}function P(t,r){return window.FileReader&&r?t.files[0].size<=r*1e3:!0}return u}.apply(A,p),g!==void 0&&(v.exports=g)}}]);
